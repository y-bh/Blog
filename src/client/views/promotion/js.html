<!--
 * @Author: 秦琛
 * @LastEditors: 秦琛
 * @description: page description
 * @Date: 2022-05-10 13:55:26
 * @LastEditTime: 2022-05-12 10:23:59
-->
<script>
    // const { post, get } = require("utils/request");
    // console.log(post, get, 'post,get');
    $(function () {
        let sameTime = 'false';
        let timeout = 60;
        let timeout2 = 60;
        let timeout3 = 60;
        // 验证用户名输入
        function usernameValidate (val) {
            let value = val;
            let reg = /^[a-zA-Z0-9_@]{4,16}$/;
            let flag = reg.test(value);
            if (!value) {
                $message.warning({
                    message: "用户名不能为空",
                    showClose: true
                })
                return false;
            } else if (!flag) {
                if (value.length < 4 || value.length > 16) {
                    $message.warning({
                        message: "用户名长度在4到16个字符",
                        showClose: true
                    })
                    return false;
                }
                $message.warning({
                    message: "用户名只能由字母，数字，_@组成",
                    showClose: true
                })
                return false;
            } else {
                sameTime = 'false';
                return true;
            }
        }

        // 验证手机格式
        function phoneValidate (val) {
            sameTime = 'true';
            let value = val;
            let reg = /^1[34589]\d{9}|17[2-9]\d{8}|16[0-1]\d{8}|16[3-4]\d{8}|166\d{8}|16[8-9]\d{8}$/;
            let flag = reg.test(value);
            if (!value) {
                $message.warning({
                    message: "请输入手机号",
                    showClose: true
                })
                return false;
            } else if (!flag) {
                $message.error({
                    message: "请输入正确的手机号码",
                    showClose: true
                })
                return false;
            } else {
                sameTime = 'false';
                return true;
            }
        }

        // 验证手机验证码
        function codeValidate (val) {
            sameTime = 'true';
            let value = val;
            if (!value) {
                $message.warning({
                    message: "请输入短信验证码",
                    showClose: true
                })
                return false;
            }
            let reg = /^[0-9]{6}$/;
            let flag = reg.test(value);
            if (!flag) {
                $message.error({
                    message: "请输入正确的短信验证码",
                    showClose: true
                })
                return false;
            } else {
                sameTime = 'false';
                return true;
            }
        }

        // 验证密码
        function passwordValidate (val) {
            sameTime = 'true';
            let value = val;
            if (!value) {
                $message.warning({
                    message: "请输入登录密码",
                    showClose: true
                })
                return false;
            }
            let reg = /^[a-zA-Z0-9_!@#$%^&*.]{6,20}$/;
            let flag = reg.test(value);
            if (!flag) {
                if (value.length < 6 || value.length > 20) {
                    $message.warning({
                        message: "密码长度在6到20个字符",
                        showClose: true
                    })
                    return false;
                }
                $message.warning({
                    message: "密码只能由字母，数字，特殊符号组成",
                    showClose: true
                })
                return false;
            } else {
                sameTime = 'false';
                return true;
            }
        }

        // 计数器加减事件
        $('#getReduce').click(function () {
            $(this).addClass('btnClick').siblings().removeClass('btnClick');
            let $this = $(this)[0];
            let that = $('#ip-num')[0];
            that.value = that.value - 1;
            if (that.value <= 0) {
                that.value = 0;
                $this.disabled = true;
            }
        })

        $("#getIncrease").click(function () {
            $(this).addClass('btnClick').siblings().removeClass('btnClick');
            let that = $('#ip-num')[0];
            that.value = parseInt(that.value) + 1;
            if (that.value > 0) {
                $("#getReduce")[0].disabled = false;
            }
        });
        // 数据格式切换 
        $('.data-group .menu-item').click(function () {
            $('#JSON').prop("checked") ? $('.attribute').css('display', 'block') : $('.attribute').css('display', 'none');

            $('#TXT').prop("checked") ? $('.split-sign').css('display', 'block') : $('.split-sign').css('display', 'none');
        })
        //地区选择切换
        $('.area-group .menu-item').click(function () {
            $('#province').prop("checked") ? $('.province-introduce').css('display', 'block') : $('.province-introduce').css('display', 'none');
        })

        // 注册规则验证
        //第一个注册表单　用户名失去焦点事件
        $('#userName').blur(function () {
            sameTime = 'true';
            let value = $(this).val();
            return usernameValidate.call(this, value);
        });
        $('#userName2').blur(function () {
            sameTime = 'true';
            let value = $(this).val();
            return usernameValidate.call(this, value);
        });
        $('#userName3').blur(function () {
            sameTime = 'true';
            let value = $(this).val();
            return usernameValidate.call(this, value);
        });
        $('#phoneNumber').blur(function () {
            let value = $(this).val();
            return phoneValidate.call(this, value);
        });
        $('#phoneNumber2').blur(function () {
            let value = $(this).val();
            return phoneValidate.call(this, value);
        });
        $('#phoneNumber3').blur(function () {
            let value = $(this).val();
            return phoneValidate.call(this, value);
        });

        $('#phoneCode').blur(function () {
            let value = $(this).val();
            return codeValidate.call(this, value);
        });
        $('#phoneCode2').blur(function () {
            let value = $(this).val();
            return codeValidate.call(this, value);
        });
        $('#phoneCode3').blur(function () {
            let value = $(this).val();
            return codeValidate.call(this, value);
        });

        $('#password').blur(function () {
            let value = $(this).val();
            return passwordValidate.call(this, value);
        });
        $('#password2').blur(function () {
            let value = $(this).val();
            return passwordValidate.call(this, value);
        });
        $('#password3').blur(function () {
            let value = $(this).val();
            return passwordValidate.call(this, value);
        });

        //获取验证码
        $("#getCode").click(async function () {
            if (sameTime == 'true') {
                return;
            }
            if (!usernameValidate.call($('#userName'), $('#userName').val()) || !phoneValidate.call($('#phoneNumber'), $('#phoneNumber').val())) {
                return;
            }

            let btn = $('#getCode');
            //点击按钮就将其置为不可点击，等倒计时结束将其置为可点击
            btn.attr('disabled', true);
            let params = {
                url: "/auth/registerCode",
                type: 'post',
                query: $('#phoneNumber').val().trim()
            };

            let resp = await ajax(params);
            if (!resp) {
                btn.attr('disabled', false);
                return;
            } else {
                $message.success({
                    message: '获取成功',
                    showClose: true
                })
                btn.text(timeout);
                let interval = setInterval(function () {
                    btn.attr('disabled', true);
                    btn.text(--timeout + 's后重新获取');
                    if (timeout <= 0) {
                        clearInterval(interval);
                        btn.html("重新获取");
                        timeout = 60;
                        btn.attr('disabled', false);
                        btn.css("pointer-events", "");
                    }
                }, 1000);
            }

        });

        //获取验证码
        $("#getCode2").click(async function () {
            if (sameTime == 'true') {
                return;
            }
            if (!usernameValidate.call($('#userName2'), $('#userName2').val()) || !phoneValidate.call($('#phoneNumber2'), $('#phoneNumber2').val())) {
                return;
            }


            let btn = $('#getCode2');
            //点击按钮就将其置为不可点击，等倒计时结束将其置为可点击
            btn.attr('disabled', true);
            let params = {
                url: "/auth/registerCode",
                type: 'post',
                query: $('#phoneNumber2').val().trim()
            };
            let resp = await ajax(params);
            if (resp === false) {
                btn.attr('disabled', false);
                return;
            }
            $message.success({
                message: '获取成功',
                showClose: true
            })
            btn.text(timeout2);
            let interval = setInterval(function () {
                btn.attr('disabled', true);
                btn.text(--timeout2 + 's后重新获取');
                if (timeout2 <= 0) {
                    clearInterval(interval);
                    btn.html("重新获取");
                    timeout2 = 60;
                    btn.attr('disabled', false);
                    btn.css("pointer-events", "");
                }
            }, 1000);
        });

        $("#getCode3").click(async function () {
            if (sameTime == 'true') {
                return;
            }
            if (!usernameValidate.call($('#userName3'), $('#userName3').val()) || !phoneValidate.call($('#phoneNumber3'), $('#phoneNumber3').val())) {
                return;
            }

            let btn = $('#getCode3');
            //点击按钮就将其置为不可点击，等倒计时结束将其置为可点击
            btn.attr('disabled', true);
            let params = {
                url: "/auth/registerCode",
                type: 'post',
                query: $('#phoneNumber3').val().trim()
            };
            let resp = await ajax(params);
            if (resp === false) {
                btn.attr('disabled', false);
                return;
            }
            $message.success({
                message: '获取成功',
                showClose: true
            })
            btn.text(timeout3);
            let interval = setInterval(function () {
                btn.attr('disabled', true);
                btn.text(--timeout3 + 's后重新获取');
                if (timeout3 <= 0) {
                    clearInterval(interval);
                    btn.html("重新获取");
                    timeout3 = 60;
                    btn.attr('disabled', false);
                    btn.css("pointer-events", "");
                }
            }, 1000);
        });

        // 第一个注册
        $('#register1').click(async function () {
            if (sameTime == 'true') {
                return;
            }
            let userName = $('#userName').val().trim();
            let phone = $('#phoneNumber').val().trim();
            let code = $('#phoneCode').val().trim();
            let password = $('#password').val().trim();

            if (!usernameValidate(userName) || !phoneValidate(phone) || !passwordValidate(password) || !codeValidate(code)) {
                return;
            }

            let form = getCookie('from');
            let did = getCookie('did');
            let keyword = getCookie('keyword');
            if (!did) {
                form = localStorage.getItem('from');
                did = localStorage.getItem('did');
                keyword = localStorage.getItem('keyword');
            }

            let params = {
                url: "/user/register",
                type: 'put',
                query: {
                    username: userName,
                    pwd: password,
                    phone: phone,
                    code: code,
                    from: form,
                    did: did,
                    keyword: keyword,
                    readProtocol: 1,   // 推广页默认阅读协议
                    fingerPrint: localStorage.getItem("fingerPrint"),
                }
            };

            let resp = await ajax(params);
            if (!resp) {
                return false;
            } else {
                $message.success({
                    message: '注册成功',
                    showClose: true
                })
                let hasIframe = document.getElementsByTagName('body')[0];
                $('#userName').val('');
                $('#phoneNumber').val('');
                $('#phoneCode').val('');
                $('#password').val('');
            }
        })

        $('#register2').click(async function () {
            if (sameTime == 'true') {
                return;
            }
            let userName = $('#userName2').val().trim();
            let phone = $('#phoneNumber2').val().trim();
            let code = $('#phoneCode2').val().trim();
            let password = $('#password2').val().trim();

            if (!usernameValidate(userName) || !phoneValidate(phone) || !passwordValidate(password) || !codeValidate(code)) {
                return;
            }

            let form = getCookie('from');
            let did = getCookie('did');
            let keyword = getCookie('keyword');
            if (!did) {
                form = localStorage.getItem('from');
                did = localStorage.getItem('did');
                keyword = localStorage.getItem('keyword');
            }
            let params = {
                url: "/user/register",
                type: 'put',
                query: {
                    username: userName,
                    pwd: password,
                    phone: phone,
                    code: code,
                    from: form,
                    did: did,
                    keyword: keyword,
                    readProtocol: 1,   // 推广页默认阅读协议
                    fingerPrint: localStorage.getItem("fingerPrint"),
                }
            };
            let resp = await ajax(params);
            if (!resp) {
                return false;
            } else {
                $message.success({
                    message: '注册成功',
                    showClose: true
                })
                $('#userName2').val('');
                $('#phoneNumber2').val('');
                $('#phoneCode2').val('');
                $('#password2').val('');
            }
        })

        $('#register3').click(async function () {
            if (sameTime == 'true') {
                return;
            }
            let userName = $('#userName3').val().trim();
            let phone = $('#phoneNumber3').val().trim();
            let code = $('#phoneCode3').val().trim();
            let password = $('#password3').val().trim();

            if (!usernameValidate(userName) || !phoneValidate(phone) || !passwordValidate(password) || !codeValidate(code)) {
                return;
            }

            let form = getCookie('from');
            let did = getCookie('did');
            let keyword = getCookie('keyword');
            if (!did) {
                form = localStorage.getItem('from');
                did = localStorage.getItem('did');
                keyword = localStorage.getItem('keyword');
            }
            let params = {
                url: "/user/register",
                type: 'put',
                query: {
                    username: userName,
                    pwd: password,
                    phone: phone,
                    code: code,
                    from: form,
                    did: did,
                    keyword: keyword,
                    readProtocol: 1,   // 推广页默认阅读协议
                    fingerPrint: localStorage.getItem("fingerPrint"),
                }
            };
            let resp = await ajax(params);
            if (!resp) {
                return false;
            } else {
                $message.success({
                    message: '注册成功',
                    showClose: true
                })
                let hasIframe = document.getElementsByTagName('body')[0];
                if (hasIframe && currentMessageShow) {
                    let openQQ = document.getElementById('qidian_wpa_2355160769_2464').contentWindow.document.getElementsByClassName('wpa-container');
                    setTimeout(function () {
                        openQQ[0].click();
                    }, 2500)
                }
                $('#userName3').val('');
                $('#phoneNumber3').val('');
                $('#phoneCode3').val('');
                $('#password3').val('');
            }
        })
    })
</script>